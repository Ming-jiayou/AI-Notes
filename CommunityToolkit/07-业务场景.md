# CommunityToolkit.Mvvm 实际业务场景详解

## 概述

本文档通过实际业务场景展示如何在企业级应用中使用CommunityToolkit.Mvvm开发完整的MVVM解决方案。基于MVVM-Samples项目的实际用例，涵盖从简单表单到复杂业务系统的完整开发流程。

## 场景1：完整的联系人管理系统

### 1.1 系统架构设计

```csharp
// 领域模型 - 基于实际业务需求
public record Contact(
    [property: JsonPropertyName("id")] Guid Id,
    [property: JsonPropertyName("name")] ContactName Name,
    [property: JsonPropertyName("emails")] List<Email> Emails,
    [property: JsonPropertyName("phones")] List<Phone> Phones,
    [property: JsonPropertyName("addresses")] List<Address> Addresses,
    [property: JsonPropertyName("company")] Company? Company,
    [property: JsonPropertyName("notes")] string? Notes,
    [property: JsonPropertyName("tags")] List<string> Tags,
    [property: JsonPropertyName("avatar")] string? AvatarUrl,
    [property: JsonPropertyName("created")] DateTime Created,
    [property: JsonPropertyName("modified")] DateTime Modified,
    [property: JsonPropertyName("isFavorite")] bool IsFavorite,
    [property: JsonPropertyName("groups")] List<string> Groups);

public record ContactName(
    [property: JsonPropertyName("prefix")] string? Prefix,
    [property: JsonPropertyName("first")] string First,
    [property: JsonPropertyName("middle")] string? Middle,
    [property: JsonPropertyName("last")] string Last,
    [property: JsonPropertyName("suffix")] string? Suffix);

public record Email(
    [property: JsonPropertyName("address")] string Address,
    [property: JsonPropertyName("type")] EmailType Type,
    [property: JsonPropertyName("isPreferred")] bool IsPreferred);

public record Phone(
    [property: JsonPropertyName("number")] string Number,
    [property: JsonPropertyName("type")] PhoneType Type,
    [property: JsonPropertyName("isPreferred")] bool IsPreferred);

public enum EmailType
{
    Personal,
    Work,
    Other
}

public enum PhoneType
{
    Home,
    Work,
    Mobile,
    Fax,
    Other
}
```

### 1.2 核心业务ViewModel

```csharp
// 主联系人管理ViewModel
public partial class ContactsManagerViewModel : ObservableValidator, IDisposable
{
    private readonly IContactsService _contactsService;
    private readonly IDialogService _dialogService;
    private readonly INavigationService _navigationService;
    private CancellationTokenSource _searchCancellationTokenSource = new();

    public ContactsManagerViewModel(
        IContactsService contactsService,
        IDialogService dialogService,
        INavigationService navigationService)
    {
        _contactsService = contactsService;
        _dialogService = dialogService;
        _navigationService = navigationService;
        
        InitializeContacts();
    }

    // 分组联系人显示
    [ObservableProperty]
    private ObservableGroupedCollection<string, Contact> groupedContacts = new();

    // 搜索和筛选
    [ObservableProperty]
    [NotifyCanExecuteChangedFor(nameof(ClearSearchCommand))]
    private string searchQuery = string.Empty;

    [ObservableProperty]
    private FilterMode currentFilter = FilterMode.All;

    [ObservableProperty]
    private SortMode currentSort = SortMode.Name;

    // 状态管理
    [ObservableProperty]
    private bool isLoading;

    [ObservableProperty]
    private bool hasMoreData;

    [ObservableProperty]
    private Contact? selectedContact;

    // 加载联系人
    [RelayCommand]
    private async Task LoadContactsAsync()
    {
        IsLoading = true;
        
        try
        {
            var contacts = await _contactsService.GetContactsAsync(100);
            UpdateContactsDisplay(contacts);
            
            // 处理空状态
            if (!contacts.Any())
            {
                await ShowEmptyStateAsync();
            }
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("加载联系人失败", ex.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    // 搜索功能
    [RelayCommand(CanExecute = nameof(CanClearSearch))]
    private void ClearSearch()
    {
        SearchQuery = string.Empty;
        ClearErrors(nameof(SearchQuery));
    }

    private bool CanClearSearch => !string.IsNullOrWhiteSpace(SearchQuery);

    partial void OnSearchQueryChanged(string? oldValue, string newValue)
    {
        _searchCancellationTokenSource.Cancel();
        _searchCancellationTokenSource = new CancellationTokenSource();
        
        _ = PerformSearchAsync(newValue, _searchCancellationTokenSource.Token);
    }

    private async Task PerformSearchAsync(string query, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(query))
        {
            await LoadContactsAsync();
            return;
        }

        await Task.Delay(300, token); // 防抖
        
        if (token.IsCancellationRequested) return;
        
        var filtered = await _contactsService.SearchContactsAsync(query);
        UpdateContactsDisplay(filtered);
    }

    // 群组管理
    [ObservableProperty]
    private ObservableCollection<ContactGroup> contactGroups = new();

    // 添加新联系人
    [RelayCommand]
    private async Task AddContactAsync()
    {
        var vm = new ContactEditorViewModel(_contactsService, _dialogService);
        await _navigationService.NavigateToEditorAsync(vm);
        
        // 编辑完成后自动刷新
        await LoadContactsAsync();
    }

    // 编辑联系人
    [RelayCommand]
    private async Task EditContactAsync(Contact contact)
    {
        if (contact == null) return;
        
        var vm = new ContactEditorViewModel(_contactsService, _dialogService, contact);
        await _navigationService.NavigateToEditorAsync(vm);
        
        await LoadContactsAsync();
    }

    // 批量操作
    [RelayCommand]
    private async Task DeleteContactsAsync(IEnumerable<Contact> contacts)
    {
        var contactList = contacts.ToList();
        if (!contactList.Any()) return;
        
        var confirmed = await _dialogService.ConfirmAsync(
            $"确定要删除 {contactList.Count} 个联系人吗？",
            "确认删除");
            
        if (!confirmed) return;
        
        try
        {
            await _contactsService.DeleteContactsAsync(contactList.Select(c => c.Id));
            await LoadContactsAsync();
            await _dialogService.ShowSuccessAsync("删除成功");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("删除失败", ex.Message);
        }
    }

    // 导入导出功能
    [RelayCommand]
    private async Task ImportContactsAsync()
    {
        var file = await _dialogService.SelectImportFileAsync();
        if (file == null) return;
        
        try
        {
            var result = await _contactsService.ImportContactsAsync(file.Path);
            await LoadContactsAsync();
            await _dialogService.ShowSuccessAsync(
                $"导入完成：成功 {result.SuccessCount}，失败 {result.FailedCount}");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("导入失败", ex.Message);
        }
    }

    [RelayCommand]
    private async Task ExportContactsAsync()
    {
        var file = await _dialogService.SelectExportLocationAsync();
        if (file == null) return;
        
        var allContacts = await _contactsService.GetAllContactsAsync();
        
        try
        {
            await _contactsService.ExportContactsAsync(allContacts, file.Path);
            await _dialogService.ShowSuccessAsync("导出成功");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("导出失败", ex.Message);
        }
    }

    // 同步功能
    [ObservableProperty]
    private bool isSynchronizing;

    [ObservableProperty]
    private double syncProgress;

    [RelayCommand]
    private async Task SynchronizeContactsAsync()
    {
        IsSynchronizing = true;
        
        try
        {
            await foreach (var progress in _contactsService.SyncContactsAsync())
            {
                SyncProgress = progress;
            }
            
            await LoadContactsAsync();
        }
        finally
        {
            IsSynchronizing = false;
            SyncProgress = 0;
        }
    }

    // 辅助方法
    private void UpdateContactsDisplay(IEnumerable<Contact> contacts)
    {
        var sorted = SortContacts(contacts, CurrentSort);
        
        GroupedContacts = new ObservableGroupedCollection<string, Contact>(
            sorted.GroupBy(c => GetGroupKey(c, CurrentSort))
                  .OrderBy(g => g.Key));
    }

    private static IEnumerable<Contact> SortContacts(
        IEnumerable<Contact> contacts, 
        SortMode mode)
    {
        return mode switch
        {
            SortMode.Name => contacts.OrderBy(c => c.Name.First).ThenBy(c => c.Name.Last),
            SortMode.Recent => contacts.OrderByDescending(c => c.Modified),
            SortMode.Company => contacts.OrderBy(c => c.Company?.Name).ThenBy(c => c.Name.First),
            _ => contacts
        };
    }

    private static string GetGroupKey(Contact contact, SortMode mode)
    {
        return mode switch
        {
            SortMode.Name => contact.Name.First[0].ToString().ToUpper(),
            SortMode.Recent => contact.Modified.ToString("yyyy-MM"),
            SortMode.Company => contact.Company?.Name ?? "个人",
            _ => "#"
        };
    }

    public void Dispose()
    {
        _searchCancellationTokenSource?.Dispose();
    }
}

public enum FilterMode { All, Favorites, Work, Personal, Family, Friends }
public enum SortMode { Name, Recent, Company, Frequency }
```

### 1.3 联系人编辑专用ViewModel

```csharp
public partial class ContactEditorViewModel : ObservableValidator, IDisposable
{
    private readonly IContactsService _contactsService;
    private readonly IDialogService _dialogService;
    private readonly IImageService _imageService;
    private readonly IValidationService _validationService;

    public ContactEditorViewModel(
        IContactsService contactsService,
        IDialogService dialogService,
        IImageService imageService,
        IValidationService validationService,
        Contact? existingContact = null)
    {
        _contactsService = contactsService;
        _dialogService = dialogService;
        _imageService = imageService;
        _validationService = validationService;
        
        IsEditMode = existingContact != null;
        InitializeFields(existingContact);
        SubscribeToChanges();
    }

    // 基础信息
    [ObservableProperty]
    [Required(ErrorMessage = "姓不能为空")]
    [StringLength(50, ErrorMessage = "姓不能超过50字符")]
    private string firstName = string.Empty;

    [ObservableProperty]
    [Required(ErrorMessage = "名不能为空")]
    [StringLength(50, ErrorMessage = "名不能超过50字符")]
    private string lastName = string.Empty;

    [ObservableProperty]
    private string? titlePrefix;

    [ObservableProperty]
    private string? titleSuffix;

    // 图片管理
    [ObservableProperty]
    private string? avatarUrl;

    [ObservableProperty]
    private ImageSource? avatarImage;

    // 联系信息
    public ObservableCollection<EmailItem> Emails { get; } = new();
    public ObservableCollection<PhoneItem> Phones { get; } = new();
    public ObservableCollection<AddressItem> Addresses { get; } = new();
    
    // 公司信息
    [ObservableProperty]
    private string? companyName;

    [ObservableProperty]
    private string? companyTitle;

    [ObservableProperty]
    private string? companyDepartment;

    // 分组和标签
    public ObservableCollection<string> AvailableGroups { get; } = new();
    public ObservableCollection<string> Tags { get; } = new();
    public ObservableCollection<string> SelectedGroups { get; } = new();

    // 验证状态
    [ObservableProperty]
    private string? notes;

    public ContactModel ContactModel { get; } = new();

    // 保存功能
    [RelayCommand(CanExecute = nameof(CanSave))]
    private async Task SaveContactAsync()
    {
        ValidateAllProperties();
        
        if (HasErrors)
        {
            await _dialogService.ShowValidationErrorsAsync(GetErrors());
            return;
        }

        try
        {
            var contact = BuildContact();
            
            if (IsEditMode)
            {
                await _contactsService.UpdateContactAsync(contact);
            }
            else
            {
                await _contactsService.CreateContactAsync(contact);
            }
            
            await _dialogService.ShowSuccessAsync("联系人保存成功");
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("保存失败", ex.Message);
        }
    }

    private bool CanSave => !HasErrors;

    // 图片处理
    [RelayCommand]
    private async Task PickAvatarAsync()
    {
        try
        {
            var file = await _imageService.PickImageAsync();
            if (file != null)
            {
                AvatarUrl = file.Path;
                AvatarImage = await _imageService.LoadImageAsync(AvatarUrl);
            }
        }
        catch (Exception ex)
        {
            await _dialogService.ShowErrorAsync("图片选择失败", ex.Message);
        }
    }

    // 添加/删除联系信息
    [RelayCommand]
    private void AddEmail() => Emails.Add(new EmailItem());
    
    [RelayCommand]
    private void RemoveEmail(EmailItem email) => Emails.Remove(email);
    
    [RelayCommand]
    private void AddPhone() => Phones.Add(new PhoneItem());
    
    [RelayCommand]
    private void RemovePhone(PhoneItem phone) => Phones.Remove(phone);
    
    [RelayCommand]
    private void AddAddress() => Addresses.Add(new AddressItem());
    
    [RelayCommand]
    private void RemoveAddress(AddressItem address) => Addresses.Remove(address);

    // 构建最终的联系人对象
    private Contact BuildContact()
    {
        return new Contact(
            Id: Guid.NewGuid(),
            Name: new ContactName(TitlePrefix, FirstName, null, LastName, TitleSuffix),
            Emails: Emails.Select(e => new Email(e.Address, e.Type, e.IsPrimary)).ToList(),
            Phones: Phones.Select(p => new Phone(p.Number, p.Type, p.IsPrimary)).ToList(),
            Addresses: Addresses.Select(a => new Address(a.Street, a.City, a.State, a.ZipCode, a.Type)).ToList(),
            Company: CompanyName != null ? new Company(CompanyName, CompanyTitle, CompanyDepartment) : null,
            Notes: Notes,
            Tags: Tags.ToList(),
            AvatarUrl: AvatarUrl,
            Created: DateTime.UtcNow,
            Modified: DateTime.UtcNow,
            IsFavorite: false,
            Groups: SelectedGroups.ToList());
    }

    // 数据绑定模型
    public partial class ContactModel : ObservableValidator
    {
        [ObservableProperty]
        [EmailAddress(ErrorMessage = "请输入有效的邮箱地址")]
        private string emailAddress = string.Empty;

        [ObservableProperty]
        [Phone(ErrorMessage = "请输入有效的电话号码")]
        private string phoneNumber = string.Empty;

        [ObservableProperty]
        [Required(ErrorMessage = "街道不能为空")]
        private string street = string.Empty;

        [ObservableProperty]
        [Required(ErrorMessage = "城市不能为空")]
        private string city = string.Empty;

        [ObservableProperty]
        [Required(ErrorMessage = "州/省不能为空")]
        private string state = string.Empty;

        [ObservableProperty]
        [StringLength(10, ErrorMessage = "邮编格式不正确")]
        private string zipCode = string.Empty;
    }

    public void Dispose()
    {
    }
}

// 绑定项目的辅助类
public partial class EmailItem : ObservableObject
{
    [ObservableProperty]
    private string address = string.Empty;

    [ObservableProperty]
    private EmailType type = EmailType.Personal;

    [ObservableProperty]
    private bool isPrimary;
}

public partial class PhoneItem : ObservableObject
{
    [ObservableProperty]
    private string number = string.Empty;

    [ObservableProperty]
    private PhoneType type = PhoneType.Mobile;

    [ObservableProperty]
    private bool isPrimary;
}

public partial class AddressItem : ObservableObject
{
    [ObservableProperty]
    private string street = string.Empty;

    [ObservableProperty]
    private string city = string.Empty;

    [ObservableProperty]
    private string state = string.Empty;

    [ObservableProperty]
    private string zipCode = string.Empty;

    [ObservableProperty]
    private AddressType type = AddressType.Home;
}

public enum AddressType
{
    Home,
    Work,
    Billing,
    Shipping,
    Other
}
```

